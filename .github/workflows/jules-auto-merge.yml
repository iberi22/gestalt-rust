name: Jules Auto-Integrator

on:
  pull_request:
    branches: [ "main" ]

permissions:
  contents: write
  pull-requests: write

jobs:
  wait-for-jules:
    name: Wait for entire Jules Team
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.body, 'PR created automatically by Jules') || contains(github.event.pull_request.labels.*.name, 'jules')

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests

      - name: Await Jules Session Completion
        run: python scripts/monitor_jules.py
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}

  enable-auto-merge:
    name: Queue for Integration
    runs-on: ubuntu-latest
    needs: wait-for-jules
    if: contains(github.event.pull_request.body, 'PR created automatically by Jules') || contains(github.event.pull_request.labels.*.name, 'jules')

    steps:
      - name: Enable GitHub Auto-Merge
        run: gh pr merge --auto --merge "$PR_URL"
        env:
          PR_URL: ${{github.event.pull_request.html_url}}
          GH_TOKEN: ${{secrets.GITHUB_TOKEN}}
